<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nuevo Producto - Vértice</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Sulphur+Point:wght@300;400;700&display=swap" />
    <link rel="stylesheet" href="./assets/css/comercio.productos.css" />
    <link rel="icon" type="image/x-icon" href="../front-vertice/assets/imgs/v-vertice.png" />
</head>

<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo">
                <img src="./assets/imgs/vertice-logo-largo (1).png" alt="Logo de Vértice" class="brand-logo" />
            </div>
            <nav class="sidebar-nav">
                <a href="./comercio.estadisticas.html"><i class="fas fa-chart-line"></i> Estadísticas</a>
                <h3>Administración</h3>
                <a href="comercio.producto.html" class="active"><i class="fas fa-box"></i> Productos</a>
                <a href="#"><i class="fas fa-sitemap"></i> Clientes</a>
                <a href="#"><i class="fas fa-map-marker-alt"></i> Pick Up Points</a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="header-buttons">
                    <button class="btn btn-primary">
                        <i class="fas fa-eye"></i> Visitar mi tienda
                    </button>
                    <a href="./comercio.mi-cuenta.html" class="btn btn-secondary">
                        <i class="fas fa-user-circle"></i> Mi Cuenta
                    </a>
                </div>
            </header>

            <div class="content-area">
                <h1>Nuevo Producto</h1>
                <form id="form-nuevo-producto">
                    <div class="form-group">
                        <label for="nombre">Nombre</label>
                        <input type="text" id="nombre" name="nombre" placeholder="Nombre del producto" required />
                    </div>
                    <div class="form-group">
                        <label for="descripcion">Descripción</label>
                        <textarea id="descripcion" name="descripcion" placeholder="Descripción del producto"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="stock">Stock</label>
                        <input type="number" id="stock" name="stock" placeholder="Cantidad en stock" required min="0" />
                    </div>
                    <div class="form-group">
                        <label for="precio-original">Precio Original ($)</label>
                        <input type="number" id="precio-original" name="precio-original" placeholder="Precio original"
                            step="0.01" required min="0" />
                    </div>
                    <div class="form-group">
                        <label for="precio_descuento">Precio en Oferta ($)</label>
                        <input type="number" id="precio_descuento" name="precio_descuento"
                            placeholder="Precio en oferta (opcional)" step="0.01" min="0" />
                    </div>
                    <div class="form-group">
                        <label for="categoria-input">Categoría</label>
                        <select id="categoria-input" name="categoria" class="form-control">
                            <option value=""></option>
                            <option value="comida-por-caducarse">Comida por caducarse</option>
                            <option value="para-donar">Para donar</option>
                        </select>
                    </div>
                    <div class="form-group file-upload-group">
                        <label for="imagen">Imagen del Producto</label>
                        <div class="file-upload-box" id="file-upload-box">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span id="file-name">Ningún archivo seleccionado</span>
                        </div>
                        <input type="file" id="imagen" name="foto_url" accept="image/*" class="d-none" />
                    </div>
            </div>

            <div class="form-actions">
                <a href="./comercio.producto.html" class="btn btn-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary" id="guardar-producto-btn">
                    Guardar Producto
                </button>
            </div>
            </form>
    </div>
    </main>
    </div>
    
    <script>
    /*    // CONEXION AL BACKEND Abrir selector de archivos al hacer clic en el área de carga
        document.getElementById('file-upload-box').addEventListener('click', function () {
            document.getElementById('imagen').click();
        });

        // Mostrar el nombre del archivo seleccionado
        document.getElementById('imagen').addEventListener('change', function () {
            const fileNameSpan = document.getElementById('file-name');
            if (this.files.length > 0) {
                fileNameSpan.textContent = this.files[0].name;
            } else {
                fileNameSpan.textContent = 'Ningún archivo seleccionado';
            }
        });

        document.getElementById('form-nuevo-producto').addEventListener('submit', async (e) => {
            e.preventDefault();

            const nombre = document.getElementById('nombre').value;
            const descripcion = document.getElementById('descripcion').value;
            const stock = document.getElementById('stock').value;
            const precioOriginal = document.getElementById('precio-original').value;
            const precioOferta = document.getElementById('precio_descuento').value;
            const categoria = document.getElementById('categoria-input').value;
            const imagenFile = document.getElementById('imagen').files[0];

            const formData = new FormData();
            formData.append('nombre_producto', nombre);
            formData.append('descripcion', descripcion);
            formData.append('cantidad_disponible', stock);
            formData.append('precio_original', precioOriginal);
            formData.append('precio_descuento', precioOferta);
            formData.append('categoria', categoria);
            if (imagenFile) formData.append('foto_url', imagenFile);

            try {
                // token del comercio (ajusta cómo lo obtienes)
                const token = localStorage.getItem('token');
                console.log(token);
                const res = await fetch('http://localhost:3000/api/productos', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();
                alert('Producto guardado correctamente');
                console.log(data);
            } catch (err) {
                console.error('Error al guardar el producto:', err);
                alert('Error al guardar el producto');
            }
        });*/
        // solo subir foto de producto y que se guarde visualmente
        
        // Script para seleccionar imagen de la galería
        document.addEventListener('DOMContentLoaded', function() {
            const fileUploadBox = document.getElementById('file-upload-box');
            const fileInput = document.getElementById('imagen');
            const fileNameSpan = document.getElementById('file-name');

            // Abrir selector de archivos al hacer clic en el área de carga
            fileUploadBox.addEventListener('click', function () {
                fileInput.click();
            });

            // Mostrar el nombre del archivo seleccionado y preview de la imagen
            fileInput.addEventListener('change', function () {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    
                    // Verificar que sea una imagen
                    if (file.type.startsWith('image/')) {
                        fileNameSpan.textContent = file.name;
                        
                        // Crear preview de la imagen
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            // Cambiar el contenido del upload box para mostrar la imagen
                            fileUploadBox.innerHTML = `
                                <img src="${e.target.result}" alt="Preview" style="max-width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px;">
                                <span style="display: block; margin-top: 10px; font-size: 14px; color: #666;">${file.name}</span>
                            `;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        alert('Por favor selecciona un archivo de imagen válido');
                        this.value = '';
                        fileNameSpan.textContent = 'Ningún archivo seleccionado';
                    }
                } else {
                    fileNameSpan.textContent = 'Ningún archivo seleccionado';
                    // Restaurar el contenido original del upload box
                    fileUploadBox.innerHTML = `
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span id="file-name">Ningún archivo seleccionado</span>
                    `;
                }
            });

            // Guardar producto en localStorage y redireccionar
            document.getElementById('form-nuevo-producto').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Obtener datos del formulario
                const nombre = document.getElementById('nombre').value;
                const descripcion = document.getElementById('descripcion').value;
                const stock = document.getElementById('stock').value;
                const precioOriginal = document.getElementById('precio-original').value;
                const precioOferta = document.getElementById('precio_descuento').value;
                const categoria = document.getElementById('categoria-input').value;
                const imagenFile = document.getElementById('imagen').files[0];
                
                // Validar campos obligatorios
                if (!nombre || !stock || !precioOriginal) {
                    alert('Por favor completa todos los campos obligatorios');
                    return;
                }
                
                // Función para guardar el producto
                function guardarProducto(imagenBase64 = null) {
                    const nuevoProducto = {
                        id: Date.now(), // ID único basado en timestamp
                        nombre: nombre,
                        descripcion: descripcion,
                        stock: parseInt(stock),
                        precioOriginal: parseFloat(precioOriginal),
                        precioOferta: precioOferta ? parseFloat(precioOferta) : null,
                        categoria: categoria,
                        imagen: imagenBase64 || './assets/imgs/default-product.jpg'
                    };
                    
                    // Obtener productos existentes del localStorage
                    let productos = JSON.parse(localStorage.getItem('productos')) || [];
                    
                    // Agregar el nuevo producto
                    productos.push(nuevoProducto);
                    
                    // Guardar en localStorage
                    localStorage.setItem('productos', JSON.stringify(productos));
                    
                    // Redireccionar a la página de productos
                    window.location.href = './comercio.producto.html';
                }
                
                // Si hay una imagen, convertirla a Base64
                if (imagenFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        guardarProducto(e.target.result);
                    };
                    reader.readAsDataURL(imagenFile);
                } else {
                    guardarProducto();
                }
            });
        });
    </script>
</body>

</html>